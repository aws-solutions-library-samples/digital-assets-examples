Parameters:
  s3bucket:
    Description: s3 bucket with public blockchain data
    Type: String
  schemaversion:
    Type: String
    Default: 'v1.0'
Resources:
  btcdataAccessPolicy:
    Metadata:
      'aws:copilot:description': 'An IAM ManagedPolicy for your service to access the btcdata bucket'
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: !Sub
        - Grants CRUD access to the S3 bucket ${Bucket}
        - { Bucket: !Ref s3bucket }
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: S3ObjectActions
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:PutObjectACL
              - s3:PutObjectTagging
              - s3:DeleteObject
              - s3:RestoreObject
            Resource: 
              - !Join 
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref s3bucket
                  - '/*'
          - Sid: S3ListAction
            Effect: Allow
            Action: s3:ListBucket
            Resource: 
              - !Join 
                - ''
                - - 'arn:aws:s3:::'
                  - !Ref s3bucket

  dataBucket:
    Metadata:
      'aws:copilot:description': 'An Amazon S3 bucket to store and retrieve objects for btcdata'
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: Enabled
      AccessControl: Private 
      BucketEncryption:
        ServerSideEncryptionConfiguration:
        - ServerSideEncryptionByDefault:
            SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true

  dataBucketPolicy:
    Metadata:
      'aws:copilot:description': 'A bucket policy to deny unencrypted access to the bucket and its contents'
    Type: AWS::S3::BucketPolicy
    Properties:
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ForceHTTPS
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource: 
              - !Sub ${ dataBucket.Arn}/*
              - !Sub ${ dataBucket.Arn}
            Condition: 
              Bool:
                "aws:SecureTransport": false
      Bucket: !Ref dataBucket

  AthenaWorkgroup:
    Type: AWS::Athena::WorkGroup
    Properties:
      Name: CryptoWorkGroup
      Description: CryptoWorkgroup
      RecursiveDeleteOption: true
      State: ENABLED
      WorkGroupConfiguration:
        RequesterPaysEnabled: true
        ResultConfiguration:
          OutputLocation: !Join
            - ''
            - - s3://
              - !Ref dataBucket
              - /results/

  GlueDatabase:
    Type: AWS::Glue::Database
    Properties: 
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: btc

  GlueDatabaseETH:
    Type: AWS::Glue::Database
    Properties: 
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: eth

  GlueDatabaseMarketData:
    Type: AWS::Glue::Database
    Properties: 
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: marketdata

  GlueTableBlocks:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Owner: owner
        Retention: 0
        Name: blocks
        StorageDescriptor:
          Columns:
          - Name: hash
            Type: string
          - Name: size
            Type: bigint 
          - Name: stripped_size
            Type: bigint
          - Name: weight
            Type: bigint
          - Name: number
            Type: bigint       
          - Name: version
            Type: bigint 
          - Name: merkle_root
            Type: string 
          - Name: timestamp
            Type: timestamp
          - Name: nonce
            Type: bigint
          - Name: bits
            Type: string 
          - Name: coinbase_param
            Type: string     
          - Name: transaction_count
            Type: bigint
          - Name: mediantime
            Type: timestamp 
          - Name: difficulty
            Type: double
          - Name: chainwork
            Type: string 
          - Name: previousblockhash
            Type: string
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /btc/blocks
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableTransactions:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabase
      TableInput:
        Owner: owner
        Retention: 0
        Name: transactions
        StorageDescriptor:
          Columns:
          - Name: hash
            Type: string
          - Name: size
            Type: bigint
          - Name: virtual_size
            Type: bigint
          - Name: version
            Type: bigint
          - Name: lock_time
            Type: bigint
          - Name: block_hash
            Type: string
          - Name: block_number
            Type: bigint
          - Name: block_timestamp
            Type: timestamp
          - Name: input_count
            Type: bigint
          - Name: output_count
            Type: bigint
          - Name: input_value
            Type: double
          - Name: output_value
            Type: double
          - Name: is_coinbase
            Type: boolean
          - Name: fee
            Type: double
          - Name: inputs
            Type: array<struct<index:bigint,spent_transaction_hash:string,spend_output_index:bigint,script_asm:string,script_hex:string,sequence:bigint,required_signatures:bigint,type:string,address:string,value:double>>
          - Name: outputs
            Type: array<struct<index:bigint,script_asm:string,script_hex:string,required_signatures:bigint,type:string,address:string,value:double>>
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /btc/transactions
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableBlocksETH:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseETH
      TableInput:
        Owner: owner
        Retention: 0
        Name: blocks
        StorageDescriptor:
          Columns:
            - Name: timestamp
              Type: timestamp
            - Name: number
              Type: bigint
            - Name: hash
              Type: string
            - Name: parent_hash
              Type: string
            - Name: nonce
              Type: string
            - Name: sha3_uncles
              Type: string
            - Name: logs_bloom
              Type: string
            - Name: transactions_root
              Type: string
            - Name: state_root
              Type: string
            - Name: receipts_root
              Type: string
            - Name: miner
              Type: string
            - Name: difficulty
              Type: double
            - Name: total_difficulty
              Type: double
            - Name: size
              Type: bigint
            - Name: extra_data
              Type: string
            - Name: gas_limit
              Type: bigint
            - Name: gas_used
              Type: bigint
            - Name: transaction_count
              Type: bigint
            - Name: base_fee_per_gas
              Type: bigint
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /eth/blocks
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableTransactionsETH:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseETH
      TableInput:
        Owner: owner
        Retention: 0
        Name: transactions
        StorageDescriptor:
          Columns:
            - Name: hash
              Type: string
            - Name: nonce
              Type: bigint
            - Name: transaction_index
              Type: bigint
            - Name: from_address
              Type: string
            - Name: to_address
              Type: string
            - Name: value
              Type: double       
            - Name: gas
              Type: bigint       
            - Name: gas_price
              Type: bigint
            - Name: input
              Type: string
            - Name: receipt_cumulative_gas_used
              Type: bigint
            - Name: receipt_gas_used
              Type: bigint
            - Name: receipt_contract_address
              Type: string
            - Name: receipt_root
              Type: string
            - Name: receipt_status
              Type: bigint
            - Name: block_timestamp
              Type: timestamp
            - Name: block_number
              Type: bigint
            - Name: block_hash
              Type: string
            - Name: max_fee_per_gas
              Type: bigint
            - Name: max_priority_fee_per_gas
              Type: bigint
            - Name: transaction_type
              Type: bigint
            - Name: receipt_effective_gas_price
              Type: bigint
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /eth/transactions
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableTokenTransfersETH:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseETH
      TableInput:
        Owner: owner
        Retention: 0
        Name: token_transfers
        StorageDescriptor:
          Columns:
            - Name: token_address
              Type: string
            - Name: from_address
              Type: string
            - Name: to_address
              Type: string
            - Name: value
              Type: double
            - Name: transaction_hash
              Type: string
            - Name: log_index
              Type: bigint
            - Name: block_timestamp
              Type: timestamp
            - Name: block_number
              Type: bigint
            - Name: block_hash
              Type: string
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /eth/token_transfers
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: [ ]
          SortColumns: [ ]
          StoredAsSubDirectories: false
        PartitionKeys:
          - Name: date
            Type: string
        TableType: EXTERNAL_TABLE

  GlueTableLogsETH:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseETH
      TableInput:
        Owner: owner
        Retention: 0
        Name: logs
        StorageDescriptor:
          Columns:
            - Name: log_index
              Type: bigint
            - Name: transaction_hash
              Type: string
            - Name: transaction_index
              Type: bigint
            - Name: address
              Type: string
            - Name: data
              Type: string
            - Name: topics
              Type: array<string>
            - Name: block_timestamp
              Type: timestamp
            - Name: block_number
              Type: bigint
            - Name: block_hash
              Type: string
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /eth/logs
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableTracesETH:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseETH
      TableInput:
        Owner: owner
        Retention: 0
        Name: traces
        StorageDescriptor:
          Columns:
            - Name: transaction_hash
              Type: string
            - Name: transaction_index
              Type: bigint
            - Name: from_address
              Type: string
            - Name: to_address
              Type: string
            - Name: value
              Type: double
            - Name: input
              Type: string
            - Name: output
              Type: string
            - Name: trace_type
              Type: string
            - Name: call_type
              Type: string
            - Name: reward_type
              Type: string
            - Name: gas
              Type: double
            - Name: gas_used
              Type: double
            - Name: subtraces
              Type: bigint
            - Name: trace_address
              Type: string
            - Name: error
              Type: string
            - Name: status
              Type: bigint
            - Name: block_timestamp
              Type: timestamp
            - Name: block_number
              Type: bigint
            - Name: block_hash
              Type: string
            - Name: trace_id
              Type: string
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /eth/traces
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableContractsETH:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseETH
      TableInput:
        Owner: owner
        Retention: 0
        Name: contracts
        StorageDescriptor:
          Columns:
            - Name: address
              Type: string
            - Name: bytecode
              Type: string
            - Name: block_timestamp
              Type: timestamp
            - Name: block_number
              Type: bigint
            - Name: block_hash
              Type: string
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref s3bucket
              - /
              - !Ref schemaversion
              - /eth/contracts
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        PartitionKeys:
        - Name: date
          Type: string
        TableType: EXTERNAL_TABLE

  GlueTableMarketData:
    Type: AWS::Glue::Table
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref GlueDatabaseMarketData
      TableInput:
        Owner: owner
        Retention: 0
        Name: crypto
        StorageDescriptor:
          Columns:
            - Name: ticker
              Type: string
            - Name: open_time
              Type: timestamp
            - Name: open
              Type: double
            - Name: high
              Type: double
            - Name: low
              Type: double
            - Name: close
              Type: double
            - Name: vol
              Type: double
            - Name: close_time
              Type: timestamp
            - Name: quote_asset_vol
              Type: double
            - Name: number_of_trades
              Type: bigint
            - Name: taker_base_asset_vol
              Type: double
          InputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetInputFormat
          Location: !Join
            - ''
            - - s3://
              - !Ref dataBucket
              - /marketdata/crypto/
          OutputFormat: org.apache.hadoop.hive.ql.io.parquet.MapredParquetOutputFormat
          Compressed: false
          NumberOfBuckets: -1
          SerdeInfo:
            SerializationLibrary: org.apache.hadoop.hive.ql.io.parquet.serde.ParquetHiveSerDe
            Parameters:
              serialization.format: '1'
          BucketColumns: []
          SortColumns: []
          StoredAsSubDirectories: false
        TableType: EXTERNAL_TABLE

Outputs:
  databucket:
    Description: "The name of a user-defined bucket."
    Value: !Ref dataBucket
    Export:
      Name: "public-blockchain-data-athena"